<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Matrix IPTV PWA</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
      body {
        background-color: #0d0208;
        color: #00ff41;
        font-family: "Courier New", Courier, monospace;
        margin: 0;
        padding: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      #terminal {
        flex: 1;
        white-space: pre;
        padding: 5px;
        font-size: 1.8vw; /* Responsive font size */
        line-height: 1.1;
        overflow: hidden;
        border-bottom: 1px solid #003b00;
      }
      #video-container {
        width: 100%;
        background: #000;
        display: none;
        position: relative;
        aspect-ratio: 16 / 9;
        border-top: 2px solid #00ff41;
      }
      video {
        width: 100%;
        height: 100%;
      }
      @media (min-width: 1024px) {
        #terminal {
          font-size: 14px;
          line-height: 16px;
        }
        #video-container {
          position: absolute;
          bottom: 20px;
          right: 20px;
          width: 480px;
          border: 2px solid #00ff41;
        }
      }
    </style>
  </head>
  <body>
    <div id="terminal">Loading Matrix Interface...</div>
    <div id="video-container">
      <video id="video" controls playsinline></video>
    </div>

    <script>
      // Global function for Wasm to call
      window.playStream = function (url) {
        console.log("[JS] Playing:", url);
        const video = document.getElementById("video");
        const container = document.getElementById("video-container");
        container.style.display = "block";

        if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(url);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, function () {
            video.play();
          });
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          // Native HLS support (Safari)
          video.src = url;
          video.addEventListener("loadedmetadata", function () {
            video.play();
          });
        }
      };
    </script>

    <script type="module">
      import init, { WasmClient } from "./pkg/matrix_iptv_lib.js";

      async function run() {
        try {
          await init();
          const client = new WasmClient();
          const terminal = document.getElementById("terminal");

          // Render Loop
          function step() {
            const output = client.draw();
            terminal.textContent = output;
            requestAnimationFrame(step);
          }
          requestAnimationFrame(step);

          // Input Handling
          document.addEventListener("keydown", (event) => {
            if (
              [
                "ArrowUp",
                "ArrowDown",
                "ArrowLeft",
                "ArrowRight",
                "Space",
                "Tab",
                "Shift",
              ].includes(event.code) ||
              [
                "ArrowUp",
                "ArrowDown",
                "ArrowLeft",
                "ArrowRight",
                "Space",
                "Tab",
              ].includes(event.key)
            ) {
              event.preventDefault();
            }
            client.handle_key(event.key);
          });
        } catch (e) {
          console.error("Wasm Init Failed:", e);
          document.getElementById("terminal").textContent =
            "CRITICAL FAILURE: WASM LOAD ERROR\n" + e;
        }
      }
      run();
    </script>
  </body>
</html>
